@page "/wardrobe/create"
@page "/wardrobe/create/{Id:int}"

@inject NavigationManager _navigationManager
@inject IWardrobeService _wardrobeService
@inject IItemTypeService _itemTypeService

<div>
    <h2>@Title Item</h2>
</div>

<div>
    @if (IsLoading)
    {
        <div class="loadingio-spinner-blocks-49enh9aem">
            <div class="ldio-4kmgy2v2hm7">
                <div style='left:25.919999999999998px;top:25.919999999999998px;animation-delay:0s'></div><div style='left:57.599999999999994px;top:25.919999999999998px;animation-delay:0.32894736842105265s'></div><div style='left:89.28px;top:25.919999999999998px;animation-delay:0.6578947368421053s'></div><div style='left:25.919999999999998px;top:57.599999999999994px;animation-delay:2.3026315789473686s'></div><div style='left:89.28px;top:57.599999999999994px;animation-delay:0.9868421052631579s'></div><div style='left:25.919999999999998px;top:89.28px;animation-delay:1.9736842105263157s'></div><div style='left:57.599999999999994px;top:89.28px;animation-delay:1.644736842105263s'></div><div style='left:89.28px;top:89.28px;animation-delay:1.3157894736842106s'></div>
            </div>
        </div>
    }
    else
    {
        <EditForm Model="WardrobeItem" OnValidSubmit="@Submit">
            <DataAnnotationsValidator />
            <div class="form">
                <div class="input-container">
                    <p class="input-container--text">Item Color</p>
                    <InputText @bind-Value="WardrobeItem.Color" class="item-container__input" placeholder="Enter text...">test</InputText>
                </div>
                <div class="input-container">
                    <p class="input-container--text">Item Type</p>
                    <InputSelect @bind-Value="WardrobeItem.ItemTypeModelId" class="item-container__input">
                        <option value="">Select an option</option>
                        @foreach (var itemType in ItemTypeModels)
                        {
                            <option value="@itemType.ItemTypeId">@itemType.Model</option>
                        }
                    </InputSelect>
                </div>
                <div class="input-container">
                    <p class="input-container--text">Item Price €</p>
                    <InputNumber @bind-Value="WardrobeItem.Price" class="item-container__input"></InputNumber>
                </div>
                <div class="input-container">
                    @if (WardrobeItem.ItemTypeModelId != 0)
                    {
                        <form>
                            @foreach (var size in ItemTypeModel.Sizes)
                            {
                                <input type="checkbox" class="form-check-input" id="@($"size{size.Id}")" @bind="size.IsAvailable" />
                                <label class="form-check-label" for="@($"size{size.Id}")">@size.ItemSize</label>
                            }
                        </form>
                    }                    
                </div>
                <div class="input-container">
                    <p class="input-container--text">Image Upload</p>
                    <InputFile OnChange="@HandleFileUpload" class="item-container__input" />
                </div>
                <div class="input-container">
                    <p class="input-container--text">Image</p>
                    <img src="@ImageData()" class="input-container--image"/>
                </div>
            </div>
            <ValidationMessage For="() => WardrobeItem.Color" />
            <ValidationMessage For="() => WardrobeItem.ItemTypeModelId" />
            <button type="submit" class="btn-form btn-form--submit">Submit</button>
            <NavLink href="/wardrobe"><button class="btn-form btn-form--cancel">Cancel</button></NavLink>
        </EditForm>
    }    
</div>

@code {
    [Parameter]
    public int Id { get; set; }
    private string Title { get; set; } = "Create";
    private bool IsLoading { get; set; }

    private ItemTypeModelDTO ItemTypeModel { get; set; } = new ItemTypeModelDTO();
    private WardrobeDTO WardrobeItem { get; set; } = new WardrobeDTO();
    private IEnumerable<ItemTypeModelDTO> ItemTypeModels { get; set; } = new List<ItemTypeModelDTO>();

    private async Task Submit()
    {
        if (Id == 0)
        {
            await _wardrobeService.Create(WardrobeItem);
        }
        else
        {
            await _wardrobeService.Update(WardrobeItem);
        }
        _navigationManager.NavigateTo("/wardrobe");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {     
        if (firstRender)
        {
            await LoadItem();
        }
    }

    private async Task LoadItem()
    {
        IsLoading = true;
        StateHasChanged();
        ItemTypeModels = await _itemTypeService.GetAll();
        if (Id != 0)
        {
            ItemTypeModel = await _itemTypeService.GetById(WardrobeItem.ItemTypeModelId);
            WardrobeItem = await _wardrobeService.GetById(Id);
            Title = "Update";
        }
        IsLoading = false;
        StateHasChanged();
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        var imageFile = e.File;

        if (imageFile != null)
        {
            using (var memoryStream = new MemoryStream())
            {
                await imageFile.OpenReadStream().CopyToAsync(memoryStream);
                WardrobeItem.ImageData = memoryStream.ToArray();
            }
        }
    }

    private string ImageData()
    {
        if (WardrobeItem.ImageData != null && WardrobeItem.ImageData.Length > 0)
        {
            var base64String = Convert.ToBase64String(WardrobeItem.ImageData);
            return $"data:image/jpeg;base64,{base64String}";
        }
        return "";
    }
}
